# Права доступа (Access Control)

Раздел «Права доступа» позволяет назначать и изменять права пользователей на уровне организации, объектов и дочерних сущностей системы.

## Назначение
- Определить, кто и что может просматривать, изменять, подписывать и администрировать.
- Обеспечить гибкое разграничение прав сверху вниз (организация → объект → раздел → документ).

## Уровни прав
| Право                   | Что позволяет                                                                 |
|-------------------------|-------------------------------------------------------------------------------|
| **Чтение**              | Просмотр данных и файлов.                                                     |
| **Редактирование**      | Создание/изменение/удаление данных в рамках сущности.                         |
| **Управление доступом** | Выдача/отзыв прав другим пользователям в рамках сущности и ниже по иерархии. |
| **Подписание**          | Утверждение актов, томов и прочих документов, требующих подписи.             |

## Наследование и переопределение
- Права **наследуются сверху вниз**: назначенное на уровне организации право действует на все её объекты и дочерние разделы.
- **Можно понижать** права на дочерней сущности (например, на организации «Редактирование», а на конкретном объекте — «Чтение» или даже «Нет доступа»).
- **Можно повышать** права на дочерней сущности (например, на организации «Чтение», а на конкретном объекте — «Редактирование»).
- **Новые дочерние сущности** всегда наследуют права **с родителя**, а **не** с «исключений» (override) соседних сущностей.  
  > Это гарантирует, что если на организации стоит «Чтение», новый объект **не** получит «Редактирование» только потому, что на другом объекте когда‑то выдали повышенные права.

### Рекомендация по UX
В дереве прав рядом с каждой сущностью показывать **индикатор источника** права:
- «Наследовано» (серый бейдж) или
- «Переопределено» (контрастный бейдж).
Это убирает путаницу «почему здесь редактирование, если выше чтение».

## Область видимости
- В дереве сущностей отображаются только **активные** объекты/разделы (архив скрыт).
- Права на архивные сущности не редактируются (см. раздел Архив в ТЗ «Организации»).

## Интерфейс
- Левая колонка — **дерево сущностей** (Организация → Объекты → Разделы → Документы).
- Центральная — **список пользователей** (логин, ФИО).
- Правая — **панель прав** (чекбоксы: Чтение, Редактирование, Управление доступом, Подписание).
- Над деревом — **инкрементный поиск**: через ~1 секунду после ввода запускается поиск, все найденные сущности раскрываются; стрелками в поле поиска можно переходить по результатам, прошлые ветки сворачиваются.

## Кто может настраивать доступ
- Кнопка «Доступ» видна пользователям с правом **Управление доступом** на соответствующую сущность.
- **Владелец** организации всегда имеет максимум прав и может удалять организацию.

## Владелец
- «Владелец» — это **роль/флаг** с максимальным набором прав на организацию и её иерархию.
- Допускается **несколько владельцев**.
- Рекомендуемая политика:
  - Нельзя оставлять организацию **без владельца** (минимум один).
  - Владелец может **передать владение** другому пользователю (после подтверждения), при этом у исходного владельца можно снять флаг «Владелец», только если остаётся хотя бы один владелец.
  - Снять флаг «Владелец» у **последнего** владельца запрещено.

## Приглашения пользователей
- Приглашение инициирует владелец или пользователь с правом **Управление доступом**.
- Механика:
  1. Вводится логин/e‑mail пользователя **или** выбирается существующий.
  2. Система отправляет **уведомление внутри Piket** приглашаемому.  
     - Если пользователь не авторизован — он попадает на посадочную страницу, после входа увидит приглашение в «Уведомлениях».
  3. Приглашение можно **принять** или **отклонить**.
  4. Срок действия приглашения — **7 дней** (после истечения приглашение становится неактивным).
- В карточке пользователя в списке доступны его **публичные** данные профиля (как разрешил сам пользователь в настройках).

## Логирование и аудит
- Фиксируются: выдача/изменение/отзыв прав, отправка/принятие/отклонение приглашений, передача владения.
- Хранятся: время, кто изменил, кого затронуло, на какой сущности и какие права.
- Историю прав для «авто‑отката» не ведём (rollback не предусмотрен); откат — вручную через повторную настройку.

## Валидация и безопасность
- Все операции — по HTTPS.
- Право «Управление доступом» не может быть выдано пользователем, у которого самого его нет (никаких «самоповышений»).
- Нельзя выдать права выше, чем у текущего администратора **на этой сущности** (принцип наименьших привилегий).

## Ошибки и состояния
- Если выбран пользователь без доступа к родителю, а админ пытается выдать права на дочернюю сущность — появится подсказка «Права будут наследоваться от родителя на минимально необходимом уровне».
- При попытке снять право, которое приводит к конфликту (например, убрать у последнего владельца флаг «Владелец») — блокируем действие и показываем объяснение.

