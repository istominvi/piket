# API и URL-паттерны

Черновик базовых маршрутов SPA и REST API для системы **Piket.pro**.  
Документ служит ориентиром для фронтенд- и бэкенд-разработчиков, чтобы формировать единый стиль адресов.

## Базовый URL

- Production: `https://api.piket.pro/v1/`
- Клиентское приложение: `https://app.piket.pro/`

> Во всех примерах ниже префикс **`/v1`** опущен для краткости.

## SPA (Frontend) URL-паттерны

### Общие страницы
- `/login` — вход в систему.
- `/registration` — регистрация.
- `/orgs` — список организаций.
- `/orgs/:orgId` — активная организация (переход в последний открытый раздел или в «Объекты» по умолчанию).
- `/objects` — список объектов активной организации.
- `/objects/:objectId/files` — файлы объекта.
- `/objects/:objectId/journal` — журнал работ.
- `/objects/:objectId/acts` — акты объекта.
- `/plans` — тарифные планы активной организации.
- `/access` — управление доступом к организации или объекту.
- `/analytics` — аналитика организации.

> Примечание: SPA будет работать на домене `app.piket.pro`, а публичный лендинг — на `piket.pro`.

---

## REST API (Backend)

### Аутентификация
# Аутентификация и сессии

## Модель
- Авторизация — через **HttpOnly** cookies.
- **Сессия бессрочная**: автоматически продлевается при активности пользователя (refresh-механизм). Пользователь остаётся в системе, пока явно не выйдет.
- Токены:
  - Access-токен — короткоживущий, автоматически обновляется на клиенте (silent refresh).
  - Refresh-токен — хранится в HttpOnly-cookie, ротация при каждом обновлении.
- Безопасность:
  - Cookies: `HttpOnly`, `Secure`, `SameSite=Lax`.
  - При смене пароля или ручном выходе — все активные сессии пользователя становятся недействительными.

## Эндпоинты
- `POST /api/v1/auth/login`
  - Вход по `username|email` + `password`.
  - Ответ: `Set-Cookie` с токенами, `{ user }`.

- `POST /api/v1/auth/refresh`
  - Тихое обновление токенов, использует refresh-cookie.
  - Ответ: `Set-Cookie` с новыми токенами.

- `POST /api/v1/auth/logout`
  - Инвалидирует refresh-токен, очищает cookies.

- `GET /api/v1/auth/me`
  - Возвращает текущего пользователя и активный контекст организации/объекта (если задан на сервере).

## Активная организация (client-side)
- Активная организация сохраняется **только в `sessionStorage`** (на уровне вкладки браузера).
- Разные вкладки могут иметь **разные активные организации**.
- На сервер передаётся `X-Org-Id` (или query `orgId`) из состояния вкладки.


### Пользователи
- `GET /api/users/me` — профиль текущего пользователя.
- `PATCH /api/users/me` — обновление своего профиля.
- `GET /api/users/:id` — профиль другого пользователя (с учётом приватных полей).

### Организации

- Базовый путь (рекомендуемый): **`/orgs`**
- Алиас (устаревший): **`/organizations`** (сохраняется для обратной совместимости)

Примеры:
- `GET /orgs` — список доступных пользователю организаций
- `POST /orgs` — создание новой организации
- `GET /orgs/{id}` — данные организации
- `PATCH /orgs/{id}` — обновление
- `DELETE /orgs/{id}` — архивирование/удаление
- `GET /orgs/{id}/access` — список прав пользователей


### Объекты
- `GET /api/organizations/:orgId/objects` — список объектов организации.
- `POST /api/organizations/:orgId/objects` — создание объекта.
- `GET /api/objects/:id` — данные объекта.
- `PATCH /api/objects/:id` — обновление объекта.
- `DELETE /api/objects/:id` — удаление (архив).
- `GET /api/objects/:id/files` — список файлов объекта.

### Файлы
- `POST /api/objects/:id/files` — загрузка файла в объект.
- `GET /api/files/:fileId` — информация о файле.
- `DELETE /api/files/:fileId` — удаление файла (в корзину).
- `PATCH /api/files/:fileId` — переименование или перемещение.
- `GET /api/files/:fileId/download` — скачивание файла.

### Тарифные планы
- `GET /api/plans` — список тарифов.
- `GET /api/organizations/:orgId/plan` — текущий тариф организации.
- `POST /api/organizations/:orgId/plan` — смена тарифа.
- `GET /api/organizations/:orgId/payments` — история оплат.

### Права доступа
- `GET /api/access/:entityType/:entityId` — текущие права пользователей на сущность.
- `POST /api/access/:entityType/:entityId` — изменение прав.

### Аналитика
- `GET /api/organizations/:orgId/analytics` — свод по организации.
- `GET /api/objects/:objectId/analytics` — (зарезервировано, не используется в MVP).

---

## Принципы именования
- Все пути в REST API начинаются с `/api/`.
- В URL всегда используется **множественное число** для коллекций (`/organizations`, `/objects`).
- Для вложенных ресурсов используется иерархия `/parent/:id/child`.
- Идентификаторы (`:id`) всегда в формате UUID (или bigint — уточнить на этапе БД).

---

## Ответы API (JSON)

### Пример списка организаций
```json
[
  {
    "id": "uuid",
    "shortName": "ООО ДорСтрой",
    "inn": "1234567890",
    "plan": "PRO",
    "objectsCount": 3,
    "storageUsed": 1024000000,
    "storageLimit": 2147483648,
    "subscriptionEnd": "2025-10-01"
  }
]
