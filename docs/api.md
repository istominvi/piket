# API и URL-паттерны

Черновик базовых маршрутов SPA и REST API для системы **Piket.pro**.  
Документ служит ориентиром для фронтенд- и бэкенд-разработчиков, чтобы формировать единый стиль адресов.

## Базовый URL

- Production: `https://api.piket.pro/v1/`
- Клиентское приложение: `https://app.piket.pro/`

> Во всех примерах ниже префикс **`/v1`** опущен для краткости.

## SPA (Frontend) URL-паттерны

### Общие страницы
- `/login` — вход в систему.
- `/registration` — регистрация.
- `/orgs` — список организаций.
- `/orgs/:orgId` — активная организация (переход в последний открытый раздел или в «Объекты» по умолчанию).
- `/objects` — список объектов активной организации.
- `/objects/:objectId/files` — файлы объекта.
- `/objects/:objectId/journal` — журнал работ.
- `/objects/:objectId/acts` — акты объекта.
- `/plans` — тарифные планы активной организации.
- `/access` — управление доступом к организации или объекту.
- `/analytics` — аналитика организации.

> Примечание: SPA будет работать на домене `app.piket.pro`, а публичный лендинг — на `piket.pro`.

---

## REST API (Backend)

### Аутентификация
# Аутентификация и сессии

## Модель
- Авторизация — через **HttpOnly** cookies.
- **Сессия бессрочная**: автоматически продлевается при активности пользователя (refresh-механизм). Пользователь остаётся в системе, пока явно не выйдет.
- Токены:
  - Access-токен — короткоживущий, автоматически обновляется на клиенте (silent refresh).
  - Refresh-токен — хранится в HttpOnly-cookie, ротация при каждом обновлении.
- Безопасность:
  - Cookies: `HttpOnly`, `Secure`, `SameSite=Lax`.
  - При смене пароля или ручном выходе — все активные сессии пользователя становятся недействительными.

## Эндпоинты

- `POST /auth/login`
  - Вход по `username|email` + `password`.
  - Ответ: `Set-Cookie` с токенами, `{ user }`.

- `POST /auth/refresh`
  - Тихое обновление токенов (refresh-cookie).
  - Ответ: `Set-Cookie` с новыми токенами.

- `POST /auth/logout`
  - Инвалидирует refresh-токен, очищает cookies.

- `GET /auth/me`
  - Возвращает текущего пользователя и активный контекст (если задан на сервере).

### Пользователи
- `GET /users/me` — профиль текущего пользователя.
- `PATCH /users/me` — обновление своего профиля.
- `GET /users/{id}` — профиль другого пользователя (с учётом приватных полей).

### Организации
- Базовый путь (рекомендуемый): **`/orgs`**

Примеры:
- `GET /orgs`
- `POST /orgs`
- `GET /orgs/{id}`
- `PATCH /orgs/{id}`
- `DELETE /orgs/{id}`
- `GET /orgs/{id}/access`

## Активная организация (client-side)
- Активная организация сохраняется **только в `sessionStorage`** (на уровне вкладки браузера).
- Разные вкладки могут иметь **разные активные организации**.
- На сервер передаётся `X-Org-Id` (или query `orgId`) из состояния вкладки.

Примеры:
- `GET /orgs` — список доступных пользователю организаций
- `POST /orgs` — создание новой организации
- `GET /orgs/{id}` — данные организации
- `PATCH /orgs/{id}` — обновление
- `DELETE /orgs/{id}` — архивирование/удаление
- `GET /orgs/{id}/access` — список прав пользователей


### Объекты
- `GET /orgs/{orgId}/objects` — список объектов организации.
- `POST /orgs/{orgId}/objects` — создание объекта.
- `GET /objects/{id}` — данные объекта.
- `PATCH /objects/{id}` — обновление объекта.
- `DELETE /objects/{id}` — удаление (архив).
- `GET /objects/{id}/files` — список файлов объекта.

### Файлы
- `POST /objects/{id}/files` — загрузка файла в объект.
- `GET /files/{fileId}` — информация о файле.
- `PATCH /files/{fileId}` — переименование/перемещение.
- `DELETE /files/{fileId}` — удаление (в корзину).
- `GET /files/{fileId}/download` — скачивание файла.

### Тарифные планы
- `GET /plans` — список тарифов.
- `GET /orgs/{orgId}/plan` — текущий тариф организации.
- `POST /orgs/{orgId}/plan` — смена тарифа.
- `GET /orgs/{orgId}/payments` — история оплат.

### Права доступа
- `GET /access/{entityType}/{entityId}` — текущие права пользователей на сущность.
- `POST /access/{entityType}/{entityId}` — изменение прав.

### Аналитика
- `GET /orgs/{orgId}/analytics` — свод по организации.
- `GET /objects/{objectId}/analytics` — (зарезервировано).

---

## Принципы именования
- Коллекции — во множественном числе: `/orgs`, `/objects`.
- Вложенные ресурсы: `/parent/{id}/child`.
- Идентификаторы ( `{id}` ) — UUID.

---

## Ответы API (JSON)

### Пример списка организаций
```json
[
  {
    "id": "c6a9f2a0-9c1a-4b9b-9f6a-1f0e6d7a1111",
    "shortName": "ООО ДорСтрой",
    "inn": "1234567890",
    "plan": "PRO",
    "objectsCount": 3,
    "storageUsed": 1024000000,
    "storageLimit": 2147483648,
    "subscriptionEnd": "2025-10-01"
  }
]

